"use strict";angular.module("Auth",["ui.router","ngCookies","User"]),angular.module("Auth").factory("Auth",["$timeout","$q","User","Session",function(a,b,c,d){function e(a){d.set(a),g=a,h=!0}function f(a){a&&(a.Email=a.Email?$.trim(a.Email):null,a.Password=a.Password?$.trim(a.Password):null)}var g=d.get()||new c,h=g.Email&&g.Email.length>0,i={isAuthenticated:function(){return h},login:function(d){var g=b.defer();return f(d),a(function(){if(!d)return g.reject("You should specify user credentials");var a=c.find(d.Email);a&&a.Password==d.Password?(e(a),g.resolve(a)):g.reject("No user found with credentials - "+d.Email+":"+d.Password)},200),g.promise},logout:function(){d.remove(),g=new c,h=!1},register:function(d){var g=b.defer();return a(function(){if(!d)return g.reject("You should specify new user info");if(f(d),!d.Email||!d.Email.length)return g.reject("You should specify E-Mail for new user");if(!d.Password||!d.Password.length)return g.reject("You should specify password for new user");var a=c.find(d.Email);a?g.reject("User with specified E-Mail already exists"):(c.add(d),e(d),g.resolve(d))},200),g.promise},getUserTitle:function(){return h?g.Email:""},User:c};return i}]).run(["$rootScope","$state","Auth",function(a,b,c){a.$on("$stateChangeStart",function(d,e){e.publicUrl||c.isAuthenticated()||(a.error="Access denied",d.preventDefault(),b.go("login"))})}]),angular.module("Auth").controller("LoginCtrl",["$scope","$state","Auth",function(a,b,c){a.User=new c.User,a.ErrorMessage="",a.IsLoading=!1,a.onLoginClick=function(){a.IsSubmitting=!0,a.ErrorMessage=null,a.form.$valid&&(a.IsLoading=!0,c.login(a.User).then(function(){b.go("home.contacts")},function(){a.ErrorMessage="Couldn't authenticate with specified credentials."})["finally"](function(){a.IsLoading=!1}))}}]),angular.module("Auth").controller("RegisterCtrl",["$scope","$state","Auth",function(a,b,c){a.User=new c.User,a.ErrorMessage="",a.IsLoading=!1,a.onRegisterClick=function(){a.IsSubmitting=!0,a.ErrorMessage=null,a.form.$valid&&(a.IsLoading=!0,c.register(a.User).then(function(){b.go("home.contacts")},function(b){a.ErrorMessage="Couldn't register user: "+b})["finally"](function(){a.IsLoading=!1}))}}]),angular.module("Auth").factory("Session",["$cookieStore",function(a){return{get:function(){return a.get("AddressBookUser")},set:function(b){a.put("AddressBookUser",b)},remove:function(){a.remove("AddressBookUser")}}}]),angular.module("Contacts",["ui.bootstrap","ui.utils","Underscore","Auth","Dialogs","Utils"]),angular.module("Contacts").controller("ContactsListCtrl",["$scope","Contacts","Dialogs","Utils",function(a,b,c,d){function e(c){a.IsLoading=!0,b.list(c-1,a.Pager.PageSize,a.Sort,a.SearchText).then(function(b){var c;a.Grouping.By?(c=_.groupBy(b.Contacts,a.Grouping.By),c=_.map(c,function(a,b){return{Group:b,Contacts:a}})):c=[{Group:void 0,Contacts:b.Contacts}],a.Contacts=c,a.Pager=b.Pager,a.Pager.PageIndex++},function(){})["finally"](function(){a.IsLoading=!1})}function f(b){c.open({templateUrl:"contacts/editContactDialog.html",controller:"EditContactCtrl",keyboard:!1,backdrop:"static",scope:a,resolve:{contact:function(){return b}}}).then(function(){e(a.Pager.PageIndex)})}a.Contacts=[],a.IsLoading=!1,a.Pager=new d.Pager,a.AvailableGroupings=[{Name:"None",Sort:"Name"},{Name:"Group",By:"Group",Sort:"Group"}],a.Grouping=a.AvailableGroupings[0],a.$watch("Grouping",function(){a.Sort.Field=a.Grouping.Sort,a.Sort.Desc=!1,e(1)}),a.Sort={Field:"Name",Desc:!1},a.$watch("Sort.Field+Sort.Desc",function(){e(a.Pager.PageIndex)}),a.SearchText="";var g="";a.onSearchClick=function(){a.SearchText=$.trim(a.SearchText),a.SearchText!=g&&(g=a.SearchText,e(1))},a.onSelectPage=function(b){b!=a.Pager.PageIndex&&e(b)},a.onAddClick=function(){f(new b.Types.Contact)},a.onEditClick=function(a){f(angular.copy(a))},a.onDeleteClick=function(d,f){c.confirm({message:f}).then(function(){b["delete"](d).then(function(){e(a.Pager.PageIndex)})})},e(1)}]),angular.module("Contacts").factory("Contacts",["Auth","LocalStorage","Utils","$q","$timeout","$filter","_",function(a,b,c,d,e,f,g){function h(){return"contacts_"+a.getUserTitle()}function i(){return b.get(h())||[]}function j(a){b.put(h(),a)}function k(){this.Id=0,this.Name="",this.Surname="",this.Phone="",this.Group=""}function l(){var a=i();angular.forEach(a,function(a){m=Math.max(m,a.Id)}),m++}var m=0;return l(),{list:function(a,b,g,h){var j=d.defer();return e(function(){if(void 0==a||void 0==b||0>a||0>=b)return j.reject("Invalid pager parameters");var d=i();if(g){var e=(g.Desc?"-":"+")+g.Field;d=f("orderBy")(d,e)}if(h&&h.length>0){var k=new RegExp(c.escapeRegExp(h),"i"),l=h.replace(/\D/g,""),m=l.length?new RegExp(c.escapeRegExp(l),"i"):null;d=f("filter")(d,function(a){return a.Name.search(k)>=0||a.Surname.search(k)>=0||m&&a.Phone.search(m)>=0})}var n=a*b,o=d.slice(n,n+b),p=new c.Pager;p.PageSize=b,p.PageIndex=Math.min(a,d.length/b),p.TotalResults=d.length,j.resolve({Contacts:o,Pager:p})},300),j.promise},save:function(a){var b=d.defer();return e(function(){if(!a.Name||!$.trim(a.Name).length)return b.reject("Name is mandatory field");if(!a.Phone||!$.trim(a.Phone).length)return b.reject("Phone is mandatory field");a.Name=$.trim(a.Name),a.Surname=$.trim(a.Surname),a.Phone=$.trim(a.Phone),a.Group=$.trim(a.Group);var c=i(),d=f("filter")(c,{Phone:a.Phone});if(d&&d.length&&d[0].Id!=a.Id)return b.reject("Already exists contact with the same phone");if(void 0==a.Id||a.Id<=0)a.Id=m++,c.push(a);else{var e=f("filter")(c,{Id:a.Id});if(!e)return b.reject("Couldn't find contact with Id = "+a.Id);var g=e[0];angular.copy(a,g)}j(c),b.resolve(a)},300),b.promise},"delete":function(a){var b=d.defer();return e(function(){var c=i(),d=g.indexOf(c,g.find(c,function(b){return b.Id==a.Id}));return d>=0?(c.splice(d,1),j(c),b.resolve(d)):b.reject("Couldn't find contact with Id = "+a.Id)},300),b.promise},groups:function(){var a=d.defer();return e(function(){var b=i(),c=[];angular.forEach(b,function(a){var b=a.Group;if(b){var d=b.toLowerCase(),e=function(a){return a.toLowerCase()==d?a:null};0==$.grep(c,e).length&&c.push(b)}}),c=f("orderBy")(c,function(a){return a}),a.resolve(c)},100),a.promise},Types:{Contact:k}}}]),angular.module("Contacts").controller("EditContactCtrl",["$scope","$modalInstance","Contacts","contact",function(a,b,c,d){function e(){c.groups().then(function(b){a.Groups=b})}a.Contact=d||new c.Types.Contact,a.Title=d.Id<=0?"Add contact":"Edit contact",a.Groups=[],a.onSelectGroup=function(b){return a.Contact.Group=b,!1},a.onCancelClick=function(){b.dismiss("cancel")},a.ScopeFix={Error:null,IsLoading:!1},a.onSaveClick=function(d){a.IsSubmitting=!0,d.$invalid||(a.ScopeFix.IsLoading=!0,a.ScopeFix.Error=null,c.save(a.Contact).then(function(a){b.close(a)},function(b){a.ScopeFix.Error=b})["finally"](function(){a.ScopeFix.IsLoading=!1}))},e()}]),angular.module("AddressBookApp",["ui.router","Auth","Directives","Contacts"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("login",{url:"/login",templateUrl:"authentication/login.html",publicUrl:!0}).state("register",{url:"/register",templateUrl:"authentication/register.html",publicUrl:!0}).state("home",{"abstract":!0,templateUrl:"layout.html"}).state("home.contacts",{url:"/contacts",templateUrl:"contacts/list.html"}),b.otherwise("/contacts")}]).run(["$rootScope",function(a){a.$state={}}]),angular.module("AddressBookApp").controller("AppCtrl",["$scope","Auth","$state",function(a,b,c){a.UserTitle=b.getUserTitle(),a.onLogoutClick=function(){b.logout(),c.go("login")}}]),angular.module("Dialogs",[]).factory("Dialogs",["$modal",function(a){return{confirm:function(b){return a.open({templateUrl:"confirmDialog.html",controller:["$scope","$modalInstance","ConfirmOptions",function(a,b,c){a.Title=c.Title,a.Message=c.Message,a.onYesClick=function(){b.close(!0)},a.onNoClick=function(){b.dismiss("cancel")}}],resolve:{ConfirmOptions:function(){return{Title:b.title||"Confirm dialog",Message:b.message}}}}).result},open:function(b){return a.open(b).result}}}]),angular.module("Directives",["Utils"]).factory("DirectivesUtils",["Utils",function(a){return{createPropertiesWatch:function(b,c,d,e){c=a.stringToArray(c),d=a.stringToArray(d),angular.forEach(c,function(a){var c="form."+a,f="";angular.forEach(d,function(a){""!=f&&(f+="+"),f+=c+"."+a}),b.$watch(f,function(a){return function(){var c=b.form[a];e(c)}}(a))})},createValidationPropertiesWatch:function(b,c,d){function e(a){var c=a.$invalid&&(a.$dirty||b.IsSubmitting);d(a,c)}this.createPropertiesWatch(b,c,["$valid","$dirty"],e);var f=a.stringToArray(c);b.$watch("IsSubmitting",function(){angular.forEach(f,function(a){var c=b.form[a];e(c)})})}}}]).directive("validationHighlight",["DirectivesUtils",function(a){return{restrict:"A",link:function(b,c,d){var e=d.name;if(!e)throw'validation-highlight: Element should have property "name"';var f=$.trim(d.validationHighlight),g="parent"==f?c.parent():c.closest(f||".form-group");g.length||(g=c.parent()),a.createValidationPropertiesWatch(b,e,function(a,b){b?g.addClass("has-error"):g.removeClass("has-error")})}}}]).directive("progressIndicator",[function(){return{restrict:"E",template:'<div class="loading">           <div class="background"></div>           <div class="content">               <img src="css/img/loading.gif"/>           </div></div>'}}]).directive("sortField",[function(){return{restrict:"E",transclude:!0,scope:{"for":"@",current:"=",desc:"="},template:'<span class="sort-field" ng-click="onToggleClick()" ng-class="{ active: current == for }" style="cursor:pointer">   <span ng-transclude ></span>    <button class="btn btn-default glyphicon "           ng-class="getButtonClass()"            ng-style="getButtonStyle()"></button></span>',link:function(a){a.desc||(a.desc=!1),a.onToggleClick=function(){a.current!=a["for"]?(a.current=a["for"],a.desc=!1):a.desc=!a.desc},a.getButtonStyle=function(){var b={visibility:a.current==a["for"]?"visible":"collapse"};return b},a.getButtonClass=function(){return a.desc?"glyphicon-sort-by-attributes-alt":"glyphicon-sort-by-attributes"},a.getContentStyle=function(){var b={cursor:a["for"]!=a.current?"pointer":""};return b}}}}]),angular.module("LocalStorage",[]).factory("LocalStorage",[function(){function a(){if("undefined"==typeof Storage)throw"Local storage is not available"}function b(a){return"address_book_"+a}function c(a){if("string"!==$.type(a))throw"Key is not valid";if(a=$.trim(a),!a)throw"Key is not valid";return a}return{put:function(d,e){d=c(d),a();var f=JSON.stringify(e);window.localStorage.setItem(b(d),f)},get:function(d){d=c(d),a();var e=window.localStorage.getItem(b(d));if(!e)return null;var f=JSON.parse(e);return f},remove:function(d){d=c(d),a(),window.localStorage.removeItem(b(d))}}}]),angular.module("Underscore",[]).factory("_",function(){return window._}),angular.module("User",["LocalStorage","Auth","Underscore"]).factory("User",["LocalStorage","_",function(a,b){function c(){this.Email=null,this.Password=null}return c.find=function(c){var d=a.get("users");if(!d)return null;var e=b.findWhere(d,{Email:c});return e||null},c.add=function(b){if(!b)throw"User wasn't specified";var c=a.get("users");if(c||(c=[]),this.find(b.Email))throw"User with the same E-Mail already exists";c.push(b),a.put("users",c)},c}]),angular.module("Utils",[]).factory("Utils",[function(){return{Pager:function(){this.PageIndex=1,this.PageSize=10,this.TotalResults=0},stringToArray:function(a){if(!a)return[];if("string"!==$.type(a))return a;var b=a.split(",");return b=$.map(b,function(a){return $.trim(a)}),b=$.grep(b,function(a){return a.length?a:null})},escapeRegExp:function(a){return a.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}}}]);